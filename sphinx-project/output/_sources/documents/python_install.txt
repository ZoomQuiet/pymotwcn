Python环境搭建
==============

:Author: vbarter <caijunjie@baidu.com>

.. contents::
.. sectnum::

线上系统安装的python版本有2.2.1，2.3.4，当前稳定版本建议使用2.4.4。本文将介绍如何为非root账户搭建一个完整的python环境，一个完整的环境基本要求如下：

#. 独立的可执行环境，不同版本之间方便切换。
#. 模块安装便捷，具有类似CPAN环境。
#. 基本的数据库操作支持


.. note::

    建议在可以访问外网的机器上搭建，这样可以通过网络安装一些需要的第三方模块。


准备工作
--------

::
    
   Python-2.4.4.tgz ：python2.4.4 

   ez_setup.py ：setuptool-0.6c8 支持模块搜索安装
    
   MySQL-python-1.2.2.tar.gz ：操作mysql的python接口


安装python解释器
------------------------

::

   wget ftp://tc-nsop-test2.tc.baidu.com/home/caijunjie/download/Python-2.4.4.tgz
   
   tar zxvf Python-2.4.4.tgz

   # /home/caijunjie/software/python2.4可以替换成你想要安装的目的路径
   ./configure --prefix=/home/caijunjie/software/python2.4 

   make

   make install

修改默认使用的python解释器

::

   vim .bash_profile

修改 ``PATH`` 为：

::
   
   PATH=/home/caijunjie/software/python2.4/bin:$PATH:$HOME/bin

保存 ``.bash_profile``

::
   
   source .bash_profile


安装easy_install
------------------------
::

   wget ftp://tc-nsop-test2.tc.baidu.com/home/caijunjie/download/ez_setup.py

   python ez_setup.py


ez_setup.py安装玩后，提供一个easy_install命令，可以通过网络来安装第三方的模块，例如，安装paramiko，模块存放在/home/caijunjie/software/python2.4/lib/python2.4/site-packages中。

::
   
   easy_install paramiko



安装MySQLdb
--------------------

.. note::
    
    安装MySQLdb之前，需要确保mysql已经正确安装，建议使用mysql5.x版本。


::
    
   wget ftp://tc-nsop-test2.tc.baidu.com/home/caijunjie/download/MySQL-python-1.2.2.tar.gz

   tar zxvf MySQL-python-1.2.2.tar.gz

   cd MySQL-python-1.2.2

   
修改 ``setup.cfg`` 文件第 ``15行``
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

::
   
   # rpath修改为你mysql的安装目录
   rpath=/home/caijunjie/mysql/lib/mysql


修改 ``site.cfg`` 文件第 ``13行`` 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

::

   # mysql_config修改为mysql的安装路径
   mysql_config = /home/caijunjig/mysql/bin/mysql_config


安装MySQLdb
~~~~~~~~~~~

::

   python setup.py build

   python setup.py install

.. note::

    build过程中可能会失败，原因一般会有二个：(1)Python.h文件找不到。(2)mysqlclient_r动态连接库找不到。解决方法：
    (1)如果python是源码安装，一般都包含Python.h，需要搜索下路径，比如Ubuntu中，/usr/include/python2.5。如果非源码安装，那么就需要安装python2.5-dev包或者是python2.4-dev包。
    (2)mysqlclient_r无法定位的原因在MySQL-python-1.2.2中出现，解决方法是site.cfg配置中的threadsafe值设置为False。


测试验证是否安装成功
~~~~~~~~~~~~~~~~~~~~

.. code:: 

    >>>import MySQLdb

如果没有 ``ImportError: No module named MySQLdb`` 报错，即安装成功。




安装pysqlite2
-------------

pysqlite2是操作sqlite数据库的api接口。

.. note::

    需要两个文件:
    wget ftp://tc-nsop-test1.tc.baidu.com/home/caijunjie/share/sqlite-amalgamation-3.5.9.tar.gz
    wget ftp://tc-nsop-test1.tc.baidu.com/home/caijunjie/share/python-pysqlite2_2.4.1.orig.tar.gz


首先安装 ``sqlite-amalgamation-3.5.9.tar.gz`` 

::
   
   tar zxvf sqlite-amalgamation-3.5.9.tar.gz
   cd sqlite-amalgamation-3.5.9
   ./configure --prefix=/home/caijunjie/software/sqlite
   make && make install

接下来安装 ``python-pysqlite2_2.4.1.orig.tar.gz``

::
   
   tar zxvf python-pysqlite2_2.4.1.orig.tar.gz
   cd pysqlite-2.4.1
   vim setup.cfg
   修改如下：
   include_dirs=/home/caijunjie/software/sqlite/include
   library_dirs=/home/caijunjie/software/sqlite/lib
   python setup.py build
   python setup.py install

设置动态连接库的搜索路径

::

   LD_LIBRARY_PATH=LD_LIBRARY_PATH:/home/caijunjie/software/ssqlite/lib
   source .bash_profile

最后，测试是否成功安装

.. code:: python
   
    from pysqlite2 import test
    test.test()


安装mod_python
---------------

mod_python是apache对python的扩展支持。

下载mod_python
::

   wget http://apache.mirror.phpchina.com/httpd/modpython/mod_python-3.3.1.tgz

.. note::

   需要apache2版本。

解压安装
::

   tar zxvf mod_python-3.3.1.tgz
   cd mod_python-3.3.1
   ./configure --with-apxs=/home/caijunjie/software/apache2/bin/apxs --with-python=/home/caijunjie/software/python2.5/bin/python
   make
   make install

到 ``make`` 时候会出现如下错误
::
   
   /usr/lib64/apr-1/build/libtool --silent --mode=link gcc -o mod_python.la \
   -rpath /usr/lib64/httpd/modules -module -avoid-version    finfoobject.lo \
   hlistobject.lo hlist.lo filterobject.lo connobject.lo serverobject.lo util.lo \
   tableobject.lo requestobject.lo _apachemodule.lo mod_python.lo\
   -L/usr/local/lib/python2.5/config -Xlinker -export-dynamic -lm\
   -lpython2.5 -lpthread -ldl -lutil -lm
   /usr/bin/ld: /usr/local/lib/python2.5/config/libpython2.5.a(abstract.o):
   relocation R_X86_64_32 against `a local symbol' can not be used when making a shared object;
   recompile with -fPIC
   /usr/local/lib/python2.5/config/libpython2.5.a: could not read symbols: Bad value
   collect2: ld returned 1 exit status
   apxs:Error: Command failed with rc=65536

主要问题是64位机器上编译会出现问题，参考 `这里 <http://mail.python.org/pipermail/python-bugs-list/2006-October/035809.html>`_

解决方法，重启编译python，使其 ``enable shared`` 。
::

   cd Python-2.5.2
   rm -fr build
   ./configure --prefix=/home/caijunjie/software/python2.5 --enable-shared
   make
   make install

安装完成后运行python2.5，会发现：
::

   # /usr/local/bin/python
   python: error while loading shared libraries: libpython2.5.so.1.0: cannot open shared object file: No such file or directory

原因少了libpython2.5.so文件，解决方法:
::

   vim .bash_profile
   在 LD_LIBRARY_PATH变量中增加/home/caijunjie/software/python2.5/lib/
   source .bash_profile

现在python2.5将没有问题，然后再次编译安装mod_python，将成功。
